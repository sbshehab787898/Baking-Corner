<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baking Corner</title>
    <link rel="stylesheet" href="../assets/style.css" />
    <link rel="stylesheet" href="admin-style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/supabase-client.js"></script>
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 992px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .json-editor {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #eee;
            background: #fafafa;
            resize: vertical;
            outline: none;
        }

        .color-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .color-row input[type=color] {
            width: 48px;
            height: 36px;
            border: 1px solid #eee;
            border-radius: 0.5rem;
            cursor: pointer;
            padding: 2px;
        }

        .currency-preview {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #EC4899;
            background: #FFF0F7;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }
    </style>
</head>

<body class="admin-body">

    <div id="preloader">
        <img src="../assets/logo.jpeg" alt="Logo" class="loader-logo">
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>

    <div id="adminSidebarMount"></div>

    <main class="admin-main">
        <div class="admin-page-header">
            <span class="admin-page-overline">Configuration</span>
            <h1 class="admin-page-title">Settings</h1>
        </div>

        <div class="settings-grid">
            <!-- Left Side -->
            <div>
                <!-- Shop Info -->
                <div class="admin-card" style="margin-bottom:2rem">
                    <h2 class="admin-card-title">Shop Information</h2>
                    <div class="settings-section">
                        <div class="admin-form-group">
                            <label class="admin-label">Store Name</label>
                            <input type="text" class="admin-input" id="storeName" value="Baking Corner" />
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">WhatsApp Number</label>
                            <input type="text" class="admin-input" id="storeWA" value="+8801712730122" />
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Full Address</label>
                            <input type="text" class="admin-input" id="storeAddress"
                                value="বেকিং কর্ণার, মোজাম্মেল প্লাজা, বটতলা সংলগ্ন, শ্রীফুলিয়া রোড/টিএন্ডটি রোড, নাঙ্গলকোট, কুমিল্লা।" />

                        </div>
                    </div>
                    <button class="admin-submit-btn" onclick="saveStoreInfo()">? Save Information</button>
                </div>

                <!-- Currency -->
                <div class="admin-card" style="margin-bottom:2rem">
                    <h2 class="admin-card-title">Currency Settings</h2>
                    <div class="settings-section">
                        <div class="admin-form-group">
                            <label class="admin-label">Currency Symbol</label>
                            <input type="text" class="admin-input" id="currencySymbol" value="?"
                                oninput="updateCurrencyPreview()" />
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Symbol Position</label>
                            <select class="admin-input" id="currencyPosition" onchange="updateCurrencyPreview()"
                                style="font-style:normal">
                                <option value="before">Before Amount (?500)</option>
                                <option value="after">After Amount (500?)</option>
                            </select>
                        </div>
                        <div class="currency-preview" id="currencyPreview">? 1,200</div>
                    </div>
                    <button class="admin-submit-btn" onclick="saveCurrency(event)">? Save Currency</button>
                </div>
            </div>

            <!-- Right Side -->
            <div>
                <!-- Display Controls -->
                <div class="admin-card" style="margin-bottom:2rem">
                    <h2 class="admin-card-title">Display Options</h2>
                    <div class="settings-section">
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Show Prices</div>
                                <div class="settings-desc">Show/hide item prices on shop page</div>
                            </div>
                            <button class="toggle-switch on" id="togglePrices" onclick="toggleSetting(this)"></button>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Language Toggle</div>
                                <div class="settings-desc">Allow customers to switch EN/BN</div>
                            </div>
                            <button class="toggle-switch on" id="toggleLang" onclick="toggleSetting(this)"></button>
                        </div>
                    </div>
                </div>

                <!-- Colors -->
                <div class="admin-card">
                    <h2 class="admin-card-title">Brand Colors</h2>
                    <div class="settings-section">
                        <div class="color-row">
                            <label class="admin-label" style="display:inline;padding:0">Primary Color</label>
                            <input type="color" id="colorPrimary" value="#F9A8D4" />
                        </div>
                        <div class="color-row">
                            <label class="admin-label" style="display:inline;padding:0">Bold Accent</label>
                            <input type="color" id="colorAccent" value="#DB2777" />
                        </div>
                    </div>
                    <button class="admin-submit-btn" onclick="saveCustomizer(event)">? Save Colors</button>
                </div>
            </div>
        </div>

        <!-- Global Shop Options -->
        <div class="admin-card" style="margin-top:2rem">
            <h2 class="admin-card-title">Global Shop Options (Defaults)</h2>
            <div class="settings-grid">
                <!-- Global Pounds -->
                <div>
                    <h3
                        style="font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:1rem;color:var(--accent)">
                        ⚖️ Global Pound Options</h3>
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                        <input type="number" step="0.1" id="gPoundVal" placeholder="Pound (e.g. 1.5)"
                            class="admin-input" style="flex:1">
                        <input type="number" id="gPoundPrice" placeholder="Price (Optional)" class="admin-input"
                            style="flex:1">
                        <button class="admin-submit-btn" style="width:auto;margin:0" onclick="addGPound()">Add</button>
                    </div>
                    <div id="gPoundList" style="display:flex;flex-wrap:wrap;gap:0.5rem"></div>
                </div>

                <!-- Global Flavours -->
                <div>
                    <h3
                        style="font-size:12px;font-weight:900;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:1rem;color:#7c3aed">
                        🍓 Global Flavour Options</h3>
                    <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                        <input type="text" id="gFlavourName" placeholder="Flavour Name" class="admin-input"
                            style="flex:1">
                        <button class="admin-submit-btn" style="width:auto;margin:0;background:#7c3aed"
                            onclick="addGFlavour()">Add</button>
                    </div>
                    <div id="gFlavourList" style="display:flex;flex-wrap:wrap;gap:0.5rem"></div>
                </div>
            </div>
        </div>

        <!-- Price List Management -->
        <div class="admin-card" style="margin-top:2rem">
            <h2 class="admin-card-title">🏷️ Price List Management</h2>
            <div class="settings-section">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:0.5rem; margin-bottom:1.5rem">
                    <input type="text" id="pItemName" placeholder="Product Name (e.g. Vanilla Cake)"
                        class="admin-input">
                    <input type="text" id="pItemWeight" placeholder="Weight (e.g. 1kg)" class="admin-input">
                    <input type="text" id="pItemPrice" placeholder="Price (e.g. ৳600)" class="admin-input">
                    <button class="admin-submit-btn" style="width:auto; margin:0" onclick="addPriceItem()">Add</button>
                </div>
                <div id="pListItems"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:1rem"></div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="admin-card" style="margin-top:2rem">
            <h2 class="admin-card-title">💳 Payment Methods</h2>
            <div class="settings-section">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:0.5rem; margin-bottom:1.5rem">
                    <input type="text" id="payMethodName" placeholder="Method Name (bkash)" class="admin-input">
                    <input type="text" id="payMethodNumber" placeholder="Number (017...)" class="admin-input">
                    <input type="text" id="payMethodInstr" placeholder="Instructions (Send Money)" class="admin-input">
                    <button class="admin-submit-btn" style="width:auto; margin:0" onclick="addPayMethod()">Add</button>
                </div>
                <div id="payMethodList"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:1rem"></div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="admin-card" style="margin-top:2rem; border:1px solid #ffe8e8">
            <h2 class="admin-card-title" style="color:#ef4444">Danger Zone</h2>
            <div class="settings-section">
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Factory Reset</div>
                        <div class="settings-desc">Delete all site data and start fresh</div>
                    </div>
                    <button onclick="factoryReset()" class="admin-submit-btn"
                        style="width:auto; background:#ef4444; color:white; padding:0.5rem 2rem">Reset All</button>
                </div>
            </div>
        </div>
    </main>

    <script src="admin-shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            adminAuthGuard();
            renderAdminSidebar('settings');
            loadSettings();
            await syncAdminDataFromSupabase();
            renderGlobalOptions();
        });

        function renderGlobalOptions() {
            const pounds = JSON.parse(localStorage.getItem('poundOptions') || '[]');
            const flavours = JSON.parse(localStorage.getItem('flavourOptions') || '[]');
            const payments = JSON.parse(localStorage.getItem('paymentMethods') || '[]');
            const priceItems = JSON.parse(localStorage.getItem('priceListSynced') || '[]');

            const pList = document.getElementById('gPoundList');
            pList.innerHTML = pounds.map(p => `
                <div class="pound-chip-tag" style="padding:0.5rem 1rem">
                    ⚖️ ${p.value} - ৳${p.price || 0}
                    <button type="button" class="pound-chip-del" onclick="delGPound('${p.id}')">✕</button>
                </div>
            `).join('');

            const fList = document.getElementById('gFlavourList');
            fList.innerHTML = flavours.map(f => `
                <div class="pound-chip-tag" style="background:#faf5ff;border-color:#c4b5fd;color:#7c3aed;padding:0.5rem 1rem">
                    🍓 ${f.name}
                    <button type="button" class="pound-chip-del" style="color:#7c3aed" onclick="delGFlavour('${f.id}')">✕</button>
                </div>
            `).join('');

            const payList = document.getElementById('payMethodList');
            payList.innerHTML = payments.map(pm => `
                <div class="admin-card" style="padding:1rem">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <strong style="font-size:13px">${pm.name}</strong>
                        <button class="pound-chip-del" style="position:static" onclick="delPayMethod('${pm.id}')">✕</button>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:0.5rem">Num: ${pm.number}</div>
                    <div style="font-size:11px; color:#888; margin-top:0.25rem">${pm.instructions}</div>
                </div>
            `).join('');

            const pliList = document.getElementById('pListItems');
            pliList.innerHTML = priceItems.map(item => `
                <div class="admin-card" style="padding:1rem; border-left:4px solid #FDB9C8">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <div style="font-size:13px; font-weight:700">${item.name}</div>
                            <div style="font-size:11px; color:#888">${item.weight || ''}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:13px; font-weight:700; color:#EC4899">${item.price}</div>
                            <button class="pound-chip-del" style="position:static; margin-top:0.5rem" onclick="delPriceItem('${item.id}')">✕</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function addPriceItem() {
            const name = document.getElementById('pItemName').value.trim();
            const weight = document.getElementById('pItemWeight').value.trim();
            const price = document.getElementById('pItemPrice').value.trim();
            if (!name || !price) return alert('Enter name and price');

            const btn = event.target;
            btn.disabled = true;
            await dbAddPriceItem({ name, weight, price });
            await syncAdminDataFromSupabase();
            document.getElementById('pItemName').value = '';
            document.getElementById('pItemWeight').value = '';
            document.getElementById('pItemPrice').value = '';
            btn.disabled = false;
        }

        async function delPriceItem(id) {
            if (!confirm('Delete this price item?')) return;
            await dbDeletePriceItem(id);
            await syncAdminDataFromSupabase();
        }

        async function addPayMethod() {
            const name = document.getElementById('payMethodName').value.trim();
            const number = document.getElementById('payMethodNumber').value.trim();
            const instructions = document.getElementById('payMethodInstr').value.trim();
            if (!name) return alert('Enter method name');

            const btn = event.target;
            btn.disabled = true;
            await dbAddPaymentMethod({ name, number, instructions });
            await syncAdminDataFromSupabase();
            document.getElementById('payMethodName').value = '';
            document.getElementById('payMethodNumber').value = '';
            document.getElementById('payMethodInstr').value = '';
            btn.disabled = false;
        }

        async function delPayMethod(id) {
            if (!confirm('Delete this payment method?')) return;
            await dbDeletePaymentMethod(id);
            await syncAdminDataFromSupabase();
        }

        async function addGPound() {
            const val = parseFloat(document.getElementById('gPoundVal').value);
            const price = parseFloat(document.getElementById('gPoundPrice').value) || 0;
            if (!val) return alert('Enter pound value');

            const btn = event.target;
            btn.disabled = true;
            await dbAddGlobalPound({ id: 'P' + Date.now(), value: val, price, label: val + ' পাউন্ড' });
            await syncAdminDataFromSupabase();
            document.getElementById('gPoundVal').value = '';
            document.getElementById('gPoundPrice').value = '';
            btn.disabled = false;
        }

        async function delGPound(id) {
            if (!confirm('Delete this option?')) return;
            await dbDeleteGlobalPound(id);
            await syncAdminDataFromSupabase();
        }

        async function addGFlavour() {
            const name = document.getElementById('gFlavourName').value.trim();
            if (!name) return alert('Enter flavour name');

            const btn = event.target;
            btn.disabled = true;
            await dbAddGlobalFlavour({ id: 'F' + Date.now(), name });
            await syncAdminDataFromSupabase();
            document.getElementById('gFlavourName').value = '';
            btn.disabled = false;
        }

        async function delGFlavour(id) {
            if (!confirm('Delete this flavour?')) return;
            await dbDeleteGlobalFlavour(id);
            await syncAdminDataFromSupabase();
        }

        function loadSettings() {
            const s = JSON.parse(localStorage.getItem('siteSettings') || '{}');

            if (s.storeName) document.getElementById('storeName').value = s.storeName;
            if (s.storeWA) document.getElementById('storeWA').value = s.storeWA;
            if (s.storeAddress) document.getElementById('storeAddress').value = s.storeAddress;

            if (s.currencySymbol) document.getElementById('currencySymbol').value = s.currencySymbol;
            if (s.currencyPosition) document.getElementById('currencyPosition').value = s.currencyPosition;

            ['Prices', 'Lang'].forEach(key => {
                const val = s['toggle' + key];
                const btn = document.getElementById('toggle' + key);
                if (btn && val === false) btn.classList.remove('on');
            });

            if (s.colorPrimary) document.getElementById('colorPrimary').value = s.colorPrimary;
            if (s.colorAccent) document.getElementById('colorAccent').value = s.colorAccent;

            updateCurrencyPreview();
        }

        function saveStoreInfo() {
            const s = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            s.storeName = document.getElementById('storeName').value;
            s.storeWA = document.getElementById('storeWA').value;
            s.storeAddress = document.getElementById('storeAddress').value;
            localStorage.setItem('siteSettings', JSON.stringify(s));
            flashButton(event.target);
        }

        function saveCurrency(e) {
            const s = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            s.currencySymbol = document.getElementById('currencySymbol').value;
            s.currencyPosition = document.getElementById('currencyPosition').value;
            localStorage.setItem('siteSettings', JSON.stringify(s));
            flashButton(e.target);
        }

        function saveCustomizer(e) {
            const s = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            s.colorPrimary = document.getElementById('colorPrimary').value;
            s.colorAccent = document.getElementById('colorAccent').value;
            localStorage.setItem('siteSettings', JSON.stringify(s));
            flashButton(e.target);
        }

        function toggleSetting(btn) {
            btn.classList.toggle('on');
            const s = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            s[btn.id] = btn.classList.contains('on');
            localStorage.setItem('siteSettings', JSON.stringify(s));
        }

        function updateCurrencyPreview() {
            const sym = document.getElementById('currencySymbol').value || '?';
            const pos = document.getElementById('currencyPosition').value;
            document.getElementById('currencyPreview').textContent = pos === 'after' ? '1,200 ' + sym : sym + ' 1,200';
        }

        function flashButton(btn) {
            const oldText = btn.textContent;
            btn.textContent = '? Saved!';
            btn.style.background = '#4ade80';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.textContent = oldText;
                btn.style.background = '';
                btn.style.color = '';
            }, 2000);
        }

        function factoryReset() {
            if (!confirm('This will wipe ALL data. Continue?')) return;
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'admin.html';
        }
    </script>
</body>

</html>