<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baking Corner</title>
    <link rel="stylesheet" href="../assets/style.css" />
    <link rel="stylesheet" href="admin-style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/supabase-client.js"></script>
    <style>
        /* ── Pound section styles ── */
        .pound-section-card {
            background: white;
            border-radius: 2rem;
            padding: 2rem;
            margin-top: 1.5rem;
            border: 1.5px solid #fdb9c8;
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.06);
        }

        .pound-section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.05rem;
            font-weight: 700;
            color: #2D1E17;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pound-add-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .pound-add-row .admin-form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 110px;
        }

        .pound-add-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #EC4899, #DB2777);
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            height: 46px;
        }

        .pound-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(219, 39, 119, 0.3);
        }

        .pound-add-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .pound-chips-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 1.25rem;
            min-height: 40px;
        }

        .pound-chip-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #FFF0F7;
            border: 1.5px solid #fdb9c8;
            color: #DB2777;
            font-size: 12px;
            font-weight: 700;
            padding: 0.45rem 0.9rem 0.45rem 1rem;
            border-radius: 9999px;
            transition: all 0.25s;
        }

        .pound-chip-tag:hover {
            border-color: #EC4899;
            background: #FFE4F3;
        }

        .pound-chip-del {
            background: rgba(219, 39, 119, 0.12);
            border: none;
            color: #DB2777;
            font-size: 13px;
            font-weight: 900;
            line-height: 1;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .pound-chip-del:hover {
            background: #EC4899;
            color: white;
            transform: scale(1.15);
        }

        .pound-empty-hint {
            font-size: 11px;
            color: #aaa;
            font-style: italic;
        }

        .pound-tip {
            font-size: 10px;
            color: #a87;
            background: #FFFBF0;
            border: 1px solid #F9D77E;
            border-radius: 0.75rem;
            padding: 0.65rem 1rem;
            margin-top: 1rem;
            line-height: 1.6;
        }

        @media(max-width: 1024px) {
            .admin-main {
                margin-left: 0;
                padding: 1.5rem;
                padding-top: 5rem;
            }

            .layout-grid {
                grid-template-columns: 1fr !important;
            }

            .sticky-form {
                position: static !important;
            }
        }

        .product-row {
            display: grid;
            grid-template-columns: 56px 1fr 80px 88px;
            gap: 1rem;
            align-items: center;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid #f5f5f5;
        }

        @media(max-width: 600px) {
            .product-row {
                grid-template-columns: 56px 1fr 60px;
                grid-template-rows: auto auto;
                gap: 0.5rem;
            }

            .product-price-cell {
                grid-column: 3;
                text-align: right;
            }

            .product-row div[style*="display:flex"] {
                grid-column: 2 / span 2;
                justify-content: flex-start;
                margin-top: 0.5rem;
            }

            .table-header {
                display: none !important;
            }

            #productSearch {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem 0.4rem 2.2rem;
            }

            div[style*="position:relative"] span[style*="left:1.2rem"] {
                left: 0.8rem !important;
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body class="admin-body">

    <div id="preloader">
        <img src="../assets/logo.jpeg" alt="Logo" class="loader-logo">
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>

    <div id="adminSidebarMount"></div>

    <main class="admin-main">
        <div class="admin-page-header">
            <span class="admin-page-overline">Inventory</span>
            <h1 class="admin-page-title">Manage Products</h1>
        </div>

        <div class="layout-grid" style="display:grid;grid-template-columns:1fr 2fr;gap:2rem;align-items:start">

            <!-- Left Column: Add Product + Pound Management -->
            <div>
                <!-- Add Product Form -->
                <div class="admin-card sticky-form" style="position:sticky;top:2rem">
                    <h2 class="admin-card-title">Add New Product</h2>
                    <form onsubmit="handleAddProduct(event)">
                        <div class="admin-form-group">
                            <label class="admin-label">Product Name</label>
                            <input type="text" class="admin-input" id="pName" placeholder="e.g. Chocolate Cake"
                                required />
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Price</label>
                            <input type="number" class="admin-input" id="pPrice" placeholder="0.00" step="0.01" min="0"
                                required />
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Category</label>
                            <select class="admin-input" id="pCat" style="font-style:normal">
                                <option value="" disabled selected>লোড হচ্ছে...</option>
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Product Photos</label>

                            <!-- Drop zone -->
                            <div id="uploadBox"
                                style="border:2px dashed #fdb9c8;border-radius:1.25rem;padding:1.2rem;text-align:center;cursor:pointer;background:#fff8fb;transition:all 0.3s;"
                                onclick="document.getElementById('pImg').click()"
                                ondragover="event.preventDefault();this.style.borderColor='#EC4899';"
                                ondragleave="this.style.borderColor='#fdb9c8';"
                                ondrop="event.preventDefault();this.style.borderColor='#fdb9c8';handleDroppedFiles(event.dataTransfer.files);">
                                <div style="font-size:2rem;margin-bottom:0.3rem;">📷</div>
                                <div
                                    style="font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:0.2em;color:#EC4899;">
                                    Click or Drag to Upload Photos</div>
                                <div style="font-size:10px;color:#aaa;margin-top:0.25rem;">JPG, PNG, WEBP — Multiple
                                    allowed — Max 5MB each</div>
                                <input type="file" id="pImg" accept="image/*" multiple style="display:none;"
                                    onchange="previewImages(event.target.files)" />
                            </div>

                            <!-- Thumbnail grid -->
                            <div id="photoGrid" style="display:flex;flex-wrap:wrap;gap:0.6rem;margin-top:0.75rem;">
                            </div>

                            <div id="uploadStatus"
                                style="font-size:11px;color:#aaa;margin-top:0.4rem;text-align:center;"></div>
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Description</label>
                            <textarea class="admin-input" id="pDesc" placeholder="Brief description..."
                                style="min-height:80px;resize:vertical"></textarea>
                        </div>
                        <button type="submit" class="admin-submit-btn" id="saveProductBtn">💾 Save Product</button>
                    </form>

                    <!-- ⚖️ Pound Options Management — same page, below the form -->
                    <div class="pound-section-card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                            <div class="pound-section-title" style="margin-bottom:0">⚖️ পাউন্ড Options পরিচালনা</div>
                            <button class="admin-submit-btn"
                                style="width:auto; margin:0; font-size:10px; padding:0.4rem 1rem"
                                onclick="loadGlobalPounds()">Load Global Defaults</button>
                        </div>

                        <div class="pound-add-row">
                            <div class="admin-form-group">
                                <label class="admin-label">পাউন্ড (সংখ্যা)</label>
                                <input type="number" class="admin-input" id="poundValue" placeholder="e.g. 1, 1.5, 2"
                                    step="0.25" min="0.25" />
                            </div>
                            <div class="admin-form-group">
                                <label class="admin-label">মূল্য (টাকা)</label>
                                <input type="number" class="admin-input" id="poundPrice" placeholder="e.g. 100, 200"
                                    min="0" step="0.01" />
                            </div>
                            <div class="admin-form-group">
                                <label class="admin-label">Label (ঐচ্ছিক)</label>
                                <input type="text" class="admin-input" id="poundLabel" placeholder="e.g. ১ পাউন্ড" />
                            </div>
                            <button type="button" class="pound-add-btn" id="addPoundBtn" onclick="handleAddPound()">
                                + Add
                            </button>
                        </div>

                        <!-- Existing pound chips -->
                        <div class="pound-chips-area" id="poundChipsArea">
                            <span class="pound-empty-hint">কোনো পাউন্ড নেই — উপরে যোগ করুন</span>
                        </div>
                        <div id="poundCountBadge"
                            style="font-size:10px;color:#aaa;margin-top:0.5rem;text-align:right;letter-spacing:0.1em">
                        </div>

                        <div class="pound-tip">
                            💡 এখানে যোগ করা পাউন্ড options গুলো product page এ weight selector এ দেখা যাবে।
                            Customer চাইলে "Custom" লিখেও order দিতে পারবে।
                        </div>
                    </div>

                    <!-- 🍓 Flavour Options Management -->
                    <div class="pound-section-card" style="margin-top:1.25rem; border-color:#c4b5fd;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                            <div class="pound-section-title" style="margin-bottom:0">🍓 Flavour Options পরিচালনা</div>
                            <button class="admin-submit-btn"
                                style="width:auto; margin:0; font-size:10px; padding:0.4rem 1rem; background:#7c3aed"
                                onclick="loadGlobalFlavours()">Load Global Defaults</button>
                        </div>

                        <div class="pound-add-row">
                            <div class="admin-form-group" style="flex:1">
                                <label class="admin-label">Flavour নাম</label>
                                <input type="text" class="admin-input" id="flavourName"
                                    placeholder="e.g. Vanilla, Chocolate..."
                                    onkeydown="if(event.key==='Enter'){event.preventDefault();handleAddFlavour();}" />
                            </div>
                            <button type="button" class="pound-add-btn" id="addFlavourBtn" onclick="handleAddFlavour()"
                                style="background:linear-gradient(135deg,#7c3aed,#6d28d9);">
                                + Add
                            </button>
                        </div>

                        <!-- Existing flavour chips -->
                        <div class="pound-chips-area" id="flavourChipsArea" style="margin-top:1rem;">
                            <span class="pound-empty-hint">কোনো flavour নেই — উপরে যোগ করুন</span>
                        </div>
                        <div id="flavourCountBadge"
                            style="font-size:10px;color:#aaa;margin-top:0.5rem;text-align:right;letter-spacing:0.1em">
                        </div>

                        <div class="pound-tip" style="border-color:#ddd6fe; background:#faf5ff; color:#6d28d9;">
                            💡 এখানে যোগ করা Flavour গুলো product page এ flavour selector এ দেখা যাবে।
                            "Custom" option সবসময় শেষে থাকবে।
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products List -->
            <div>
                <!-- Search + count bar -->
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:1rem;flex-wrap:wrap">
                    <div style="position:relative;flex:1;min-width:200px">
                        <span
                            style="position:absolute;left:1.2rem;top:50%;transform:translateY(-50%);color:#aaa">🔍</span>
                        <input type="text" id="productSearch" class="admin-input"
                            style="padding-left:3rem;border-radius:9999px" placeholder="Search products..." />
                    </div>
                    <span id="productCount"
                        style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.3em;color:#aaa;white-space:nowrap">0
                        Items</span>
                </div>

                <div class="admin-card" style="padding:1.5rem">
                    <!-- Table header -->
                    <div class="table-header"
                        style="display:grid;grid-template-columns:56px 1fr 80px 44px;gap:1rem;padding:0.5rem 0.5rem 1rem;border-bottom:1px solid #f5f5f5;margin-bottom:0.5rem">
                        <span></span>
                        <span
                            style="font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:0.35em;color:#aaa">Product</span>
                        <span
                            style="font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:0.35em;color:#aaa">Price</span>
                        <span></span>
                    </div>
                    <div id="productsList"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="admin-shared.js"></script>
    <script>
        let data;
        let searchQuery = '';
        let poundOptions = []; // Form state (local)
        let flavourOptions = []; // Form state (local)
        let selectedFiles = []; // Form state (photos)
        let editingProductId = null; // null = add mode, number = edit mode

        document.addEventListener('DOMContentLoaded', async () => {
            adminAuthGuard();
            renderAdminSidebar('products');

            // Initialize data from cache first
            data = getAdminData();
            renderProducts();

            await syncAdminDataFromSupabase();

            // Re-fetch in case sync updated sessionStorage
            data = getAdminData();
            renderProducts();

            document.getElementById('productSearch').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderProducts();
            });
        });

        // ══════════════════════════════════════
        // POUND OPTIONS (LOCAL TO FORM)
        // ══════════════════════════════════════
        function renderPoundChips() {
            const area = document.getElementById('poundChipsArea');
            const badge = document.getElementById('poundCountBadge');
            if (!poundOptions || !poundOptions.length) {
                area.innerHTML = '<span class="pound-empty-hint">এই প্রোডাক্টের জন্য কোনো পাউন্ড নেই — উপরে যোগ করুন</span>';
                if (badge) badge.textContent = '';
                return;
            }
            if (badge) badge.textContent = poundOptions.length + ' টি option সংরক্ষিত';
            area.innerHTML = poundOptions.map((p, idx) => {
                const priceStr = (p.price !== undefined && p.price !== null && p.price !== '')
                    ? ` &nbsp;·&nbsp; ৳${parseFloat(p.price).toLocaleString('en-IN')}` : '';
                return `
                <div class="pound-chip-tag">
                    ⚖️ ${parseFloat(p.value)} পাউন্ড${priceStr}
                    <button type="button" class="pound-chip-del" onclick="deletePound(${idx})" title="মুছুন">✕</button>
                </div>`;
            }).join('');
        }

        async function handleAddPound() {
            const valRaw = document.getElementById('poundValue').value;
            const val = parseFloat(valRaw);
            const priceRaw = document.getElementById('poundPrice').value;
            const price = priceRaw !== '' ? parseFloat(priceRaw) : null;
            const label = document.getElementById('poundLabel').value.trim() || (val + ' পাউন্ড');

            if (!val || val <= 0) {
                alert('সঠিক পাউন্ড সংখ্যা দিন!');
                return;
            }
            if (poundOptions.some(p => parseFloat(p.value) === val)) {
                alert('এই পাউন্ড option টি আগেই আছে!');
                return;
            }

            const newOpt = { id: Date.now(), value: val, label, price };
            poundOptions.push(newOpt);
            poundOptions.sort((a, b) => parseFloat(a.value) - parseFloat(b.value));

            document.getElementById('poundValue').value = '';
            document.getElementById('poundPrice').value = '';
            document.getElementById('poundLabel').value = '';
            renderPoundChips();
        }

        function deletePound(index) {
            poundOptions.splice(index, 1);
            renderPoundChips();
        }

        // ══════════════════════════════════════
        // FLAVOUR OPTIONS (LOCAL TO FORM)
        // ══════════════════════════════════════
        function renderFlavourChips() {
            const area = document.getElementById('flavourChipsArea');
            const badge = document.getElementById('flavourCountBadge');
            if (!flavourOptions || !flavourOptions.length) {
                area.innerHTML = '<span class="pound-empty-hint">কোনো flavour নেই — উপরে যোগ করুন</span>';
                if (badge) badge.textContent = '';
                return;
            }
            if (badge) badge.textContent = flavourOptions.length + ' টি flavour সংরক্ষিত';
            area.innerHTML = flavourOptions.map((f, idx) => `
                <div class="pound-chip-tag"
                    style="background:#faf5ff;border-color:#c4b5fd;color:#7c3aed;">
                    🍓 ${f.name}
                    <button type="button" class="pound-chip-del" onclick="deleteFlavour(${idx})"
                        style="background:rgba(124,58,237,0.12);color:#7c3aed;"
                        onmouseover="this.style.background='#7c3aed';this.style.color='white';"
                        onmouseout="this.style.background='rgba(124,58,237,0.12)';this.style.color='#7c3aed';"
                        title="মুছুন">✕</button>
                </div>`).join('');
        }

        async function handleAddFlavour() {
            const name = document.getElementById('flavourName').value.trim();
            if (!name) { alert('Flavour নাম দিন!'); return; }
            if (flavourOptions.some(f => f.name.toLowerCase() === name.toLowerCase())) {
                alert('এই flavour আগেই আছে!'); return;
            }
            flavourOptions.push({ name });
            document.getElementById('flavourName').value = '';
            renderFlavourChips();
        }

        function deleteFlavour(index) {
            flavourOptions.splice(index, 1);
            renderFlavourChips();
        }

        async function loadGlobalPounds() {
            const globals = JSON.parse(localStorage.getItem('poundOptions') || '[]');
            if (!globals.length) {
                alert('সিস্টেম সেটিংসে কোনো গ্লোবাল পাউন্ড অপশন পাওয়া যায়নি।');
                return;
            }
            globals.forEach(g => {
                if (!poundOptions.some(p => parseFloat(p.value) === parseFloat(g.value))) {
                    poundOptions.push({ ...g, id: Date.now() + Math.random() });
                }
            });
            poundOptions.sort((a, b) => parseFloat(a.value) - parseFloat(b.value));
            renderPoundChips();
        }

        async function loadGlobalFlavours() {
            const globals = JSON.parse(localStorage.getItem('flavourOptions') || '[]');
            if (!globals.length) {
                alert('সিস্টেম সেটিংসে কোনো গ্লোবাল ফ্লেভার অপশন পাওয়া যায়নি।');
                return;
            }
            globals.forEach(g => {
                if (!flavourOptions.some(f => f.name.toLowerCase() === g.name.toLowerCase())) {
                    flavourOptions.push({ ...g, id: Date.now() + Math.random() });
                }
            });
            renderFlavourChips();
        }

        // ══════════════════════════════════════
        // PHOTO HANDLING
        // ══════════════════════════════════════
        function previewImages(files) {
            Array.from(files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(file.name + ' is over 5MB and was skipped.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({ file: file, url: e.target.result });
                    renderPhotoGrid();
                };
                reader.readAsDataURL(file);
            });
            document.getElementById('pImg').value = '';
        }

        function handleDroppedFiles(files) {
            previewImages(files);
        }

        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');
            const status = document.getElementById('uploadStatus');
            if (!selectedFiles.length) {
                grid.innerHTML = '';
                status.textContent = '';
                return;
            }
            status.textContent = selectedFiles.length + ' photo(s) selected';
            grid.innerHTML = selectedFiles.map((f, i) => {
                const url = f.url;
                const badge = i === 0 ? '<span style="position:absolute;top:4px;left:4px;background:#EC4899;color:white;font-size:8px;font-weight:900;letter-spacing:0.1em;padding:2px 5px;border-radius:99px;text-transform:uppercase;">Main</span>' : '';
                return `
                <div style="position:relative;width:74px;height:74px;border-radius:0.6rem;overflow:hidden;border:2px solid ${i === 0 ? '#EC4899' : '#fdb9c8'};flex-shrink:0;">
                    <img src="${url}" style="width:100%;height:100%;object-fit:cover;display:block;" />
                    ${badge}
                    <button type="button" onclick="removePhoto(${i})"
                        style="position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,0.55);color:white;border:none;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">✕</button>
                </div>`;
            }).join('');
        }

        function removePhoto(index) {
            selectedFiles.splice(index, 1);
            renderPhotoGrid();
        }

        async function uploadImageToSupabase(file) {
            if (!window.supabaseClient || !file) return null;
            const ext = file.name.split('.').pop();
            const fileName = 'product_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7) + '.' + ext;
            const { data: uploadData, error } = await window.supabaseClient
                .storage
                .from('product-images')
                .upload(fileName, file, { cacheControl: '3600', upsert: false });
            if (error) {
                console.error('Upload error:', error.message);
                return null;
            }
            const { data: urlData } = window.supabaseClient
                .storage
                .from('product-images')
                .getPublicUrl(fileName);
            return urlData.publicUrl || null;
        }

        // ══════════════════════════════════════
        // PRODUCT SAVE / UPDATE
        // ══════════════════════════════════════
        async function handleAddProduct(e) {
            e.preventDefault();
            const btn = document.getElementById('saveProductBtn');
            const originalText = editingProductId ? '💾 Update Product' : '💾 Save Product';

            btn.textContent = '⏳ Processing...';
            btn.disabled = true;

            let finalImageUrls = [];

            // Handle Photos: separate existing URLs from new File objects
            for (let f of selectedFiles) {
                if (f.file) {
                    // New upload
                    const url = await uploadImageToSupabase(f.file);
                    if (url) finalImageUrls.push(url);
                } else {
                    // Existing URL
                    finalImageUrls.push(f.url);
                }
            }

            const mainImage = finalImageUrls[0] || 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=600';

            const prodData = {
                id: Date.now(), // Generate unique ID in frontend
                name: document.getElementById('pName').value.trim(),
                price: parseFloat(document.getElementById('pPrice').value),
                category: document.getElementById('pCat').value,
                image: mainImage,
                images: finalImageUrls,
                description: document.getElementById('pDesc').value.trim(),
                pound_options: poundOptions,
                flavour_options: flavourOptions
            };

            if (editingProductId) {
                // UPDATE
                const { data: updatedProd, error } = await dbUpdateProduct(editingProductId, prodData);
                if (error) {
                    alert('Error updating product: ' + error.message);
                    btn.textContent = '❌ Failed';
                    btn.style.background = '#ef4444';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);
                    return;
                }
                const idx = data.products.findIndex(p => p.id === editingProductId);
                if (idx !== -1) data.products[idx] = updatedProd || { ...data.products[idx], ...prodData };
            } else {
                // CREATE
                const { data: newProd, error } = await dbAddProduct(prodData);
                if (error) {
                    alert('Error adding product: ' + error.message);
                    btn.textContent = '❌ Failed';
                    btn.style.background = '#ef4444';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.disabled = false;
                    }, 3000);
                    return;
                }
                data.products.unshift(newProd || { ...prodData, id: Date.now() });
            }

            saveAdminData('adminProducts', data.products);

            // Reset and UI Refresh
            resetForm();
            renderProducts();

            btn.textContent = '✅ Success!';
            btn.style.background = '#4ade80';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.disabled = false;
            }, 2000);
        }

        function resetForm() {
            editingProductId = null;
            document.querySelector('.admin-card-title').textContent = 'Add New Product';
            document.getElementById('saveProductBtn').textContent = '💾 Save Product';
            document.getElementById('pName').value = '';
            document.getElementById('pPrice').value = '';
            document.getElementById('pDesc').value = '';
            selectedFiles = [];
            poundOptions = [];
            flavourOptions = [];
            renderPhotoGrid();
            renderPoundChips();
            renderFlavourChips();
            document.getElementById('uploadStatus').textContent = '';
        }

        function editProduct(id) {
            const p = data.products.find(x => x.id === id);
            if (!p) return;

            editingProductId = id;
            document.querySelector('.admin-card-title').textContent = 'Edit Product';
            document.getElementById('saveProductBtn').textContent = '💾 Update Product';

            document.getElementById('pName').value = p.name;
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.description || '';

            // Map existing images to selectedFiles format (no 'file' object)
            selectedFiles = (p.images || [p.image]).filter(src => src).map(src => ({ file: null, url: src }));

            poundOptions = p.pound_options || [];
            flavourOptions = p.flavour_options || [];

            renderPhotoGrid();
            renderPoundChips();
            renderFlavourChips();

            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            data.products = data.products.filter(p => p.id !== id);
            saveAdminData('adminProducts', data.products);
            await dbDeleteProduct(id);
            renderProducts();
        }

        function renderProducts() {
            const list = document.getElementById('productsList');
            const count = document.getElementById('productCount');
            if (!data || !data.products) return;
            const filtered = data.products.filter(p =>
                p.name.toLowerCase().includes(searchQuery) ||
                (p.category || '').toLowerCase().includes(searchQuery)
            );

            count.textContent = filtered.length + ' Items';

            // Populate category dropdown
            const catSel = document.getElementById('pCat');
            if (catSel && data.corners && data.corners.length) {
                const prev = catSel.value;
                catSel.innerHTML = data.corners.map(c =>
                    `<option value="${c.name.toLowerCase()}">${c.name}</option>`
                ).join('') + '<option value="other">Other</option>';
                if (prev) catSel.value = prev;
            }

            const settings = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            const sym = settings.currencySymbol || '৳';
            const pos = settings.currencyPosition || 'before';
            const fmt = n => pos === 'after' ? n.toLocaleString('en-IN') + sym : sym + n.toLocaleString('en-IN');

            if (!filtered.length) {
                list.innerHTML = '<p style="color:#aaa;font-style:italic;text-align:center;padding:3rem">No products found.</p>';
                return;
            }

            list.innerHTML = filtered.map(p => `
      <div class="product-row" id="prod-${p.id}">
        <img src="${p.image || 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=100'}"
             class="product-thumb" alt="${p.name}" />
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-cat">${p.category || ''}</div>
        </div>
        <div class="product-price-cell">${fmt(parseFloat(p.price))}</div>
        <div style="display:flex; gap:0.5rem;">
            <button class="delete-btn" onclick="editProduct(${p.id})" style="background:#f0f9ff; color:#0ea5e9; border-color:#e0f2fe; width:36px;" title="Edit">✏️</button>
            <button class="delete-btn" onclick="deleteProduct(${p.id})" title="Remove" style="width:36px;">🗑️</button>
        </div>
      </div>
    `).join('');
        }
    </script>
</body>

</html>