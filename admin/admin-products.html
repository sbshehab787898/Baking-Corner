<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baking Corner</title>
    <link rel="stylesheet" href="../assets/style.css" />
    <link rel="stylesheet" href="admin-style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/supabase-client.js"></script>
</head>

<body class="admin-body">

    <div id="preloader">
        <img src="../assets/logo.jpeg" alt="Logo" class="loader-logo">
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>

    <div id="adminSidebarMount"></div>

    <main class="admin-main">
        <div class="admin-page-header">
            <span class="admin-page-overline">Inventory</span>
            <h1 class="admin-page-title">Manage Products</h1>
        </div>

        <div style="display:grid;grid-template-columns:1fr 2fr;gap:2rem;align-items:start">

            <!-- Add Product Form -->
            <div class="admin-card" style="position:sticky;top:2rem">
                <h2 class="admin-card-title">Add New Product</h2>
                <form onsubmit="handleAddProduct(event)">
                    <div class="admin-form-group">
                        <label class="admin-label">Product Name</label>
                        <input type="text" class="admin-input" id="pName" placeholder="e.g. Chocolate Cake" required />
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Price</label>
                        <input type="number" class="admin-input" id="pPrice" placeholder="0.00" step="0.01" min="0"
                            required />
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Category</label>
                        <select class="admin-input" id="pCat">
                            <option value="cakes">Cakes</option>
                            <option value="pastries">Pastries</option>
                            <option value="macarons">Macarons</option>
                            <option value="chocolates">Chocolates</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Product Photo</label>
                        <div id="uploadBox"
                            style="border:2px dashed #fdb9c8;border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;background:#fff8fb;transition:all 0.3s;position:relative;"
                            onclick="document.getElementById('pImg').click()">
                            <img id="imgPreview" src="" alt=""
                                style="display:none;width:100%;max-height:160px;object-fit:cover;border-radius:0.75rem;margin-bottom:0.75rem;" />
                            <div id="uploadPrompt">
                                <div style="font-size:2.5rem;margin-bottom:0.5rem;">📷</div>
                                <div
                                    style="font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:0.2em;color:#EC4899;">
                                    Click to Upload Photo</div>
                                <div style="font-size:10px;color:#aaa;margin-top:0.3rem;">JPG, PNG, WEBP — Max 5MB</div>
                            </div>
                            <input type="file" id="pImg" accept="image/*" style="display:none;"
                                onchange="previewImage(event)" />
                        </div>
                        <div id="uploadStatus" style="font-size:11px;color:#aaa;margin-top:0.4rem;text-align:center;">
                        </div>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Description</label>
                        <textarea class="admin-input" id="pDesc" placeholder="Brief description..."
                            style="min-height:80px;resize:vertical"></textarea>
                    </div>
                    <button type="submit" class="admin-submit-btn">? Save Product</button>
                </form>
            </div>

            <!-- Products List -->
            <div>
                <!-- Search + count bar -->
                <div
                    style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;gap:1rem;flex-wrap:wrap">
                    <div style="position:relative;flex:1;min-width:200px">
                        <span
                            style="position:absolute;left:1.2rem;top:50%;transform:translateY(-50%);color:#aaa">??</span>
                        <input type="text" id="productSearch" class="admin-input"
                            style="padding-left:3rem;border-radius:9999px" placeholder="Search products..." />
                    </div>
                    <span id="productCount"
                        style="font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:0.3em;color:#aaa;white-space:nowrap">0
                        Items</span>
                </div>

                <div class="admin-card" style="padding:1.5rem">
                    <!-- Table header -->
                    <div
                        style="display:grid;grid-template-columns:56px 1fr 80px 44px;gap:1rem;padding:0.5rem 0.5rem 1rem;border-bottom:1px solid #f5f5f5;margin-bottom:0.5rem">
                        <span></span>
                        <span
                            style="font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:0.35em;color:#aaa">Product</span>
                        <span
                            style="font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:0.35em;color:#aaa">Price</span>
                        <span></span>
                    </div>
                    <div id="productsList"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="admin-shared.js"></script>
    <script>
        let data;
        let searchQuery = '';

        document.addEventListener('DOMContentLoaded', async () => {
            adminAuthGuard();
            renderAdminSidebar('products');
            await syncAdminDataFromSupabase();
            data = getAdminData();
            renderProducts();

            document.getElementById('productSearch').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderProducts();
            });
        });

        function renderProducts() {
            const list = document.getElementById('productsList');
            const count = document.getElementById('productCount');
            const filtered = data.products.filter(p =>
                p.name.toLowerCase().includes(searchQuery) ||
                (p.category || '').toLowerCase().includes(searchQuery)
            );

            count.textContent = filtered.length + ' Items';

            // Populate category dropdown
            const catSelect = document.getElementById('pCat');
            if (catSelect && data.corners) {
                const currentVal = catSelect.value;
                catSelect.innerHTML = data.corners.map(c => `<option value="${c.name.toLowerCase()}">${c.name}</option>`).join('') + '<option value="other">Other</option>';
                if (currentVal) catSelect.value = currentVal;
            }

            const settings = JSON.parse(localStorage.getItem('siteSettings') || '{}');
            const sym = settings.currencySymbol || '?';
            const pos = settings.currencyPosition || 'before';
            const fmt = n => pos === 'after' ? n.toLocaleString('en-IN') + sym : sym + n.toLocaleString('en-IN');

            if (!filtered.length) {
                list.innerHTML = '<p style="color:#aaa;font-style:italic;text-align:center;padding:3rem">No products found.</p>';
                return;
            }

            list.innerHTML = filtered.map(p => `
      <div class="product-row" id="prod-${p.id}">
        <img src="${p.image || 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=100'}"
             class="product-thumb" alt="${p.name}"
             onerror="this.src='https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=100'"/>
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-cat">${p.category || ''}</div>
        </div>
        <div class="product-price-cell">${fmt(parseFloat(p.price))}</div>
        <button class="delete-btn" onclick="deleteProduct(${p.id})" title="Remove">??</button>
      </div>
    `).join('');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imgPreview');
                const prompt = document.getElementById('uploadPrompt');
                preview.src = e.target.result;
                preview.style.display = 'block';
                prompt.style.display = 'none';
                document.getElementById('uploadStatus').textContent = '✅ ' + file.name;
                document.getElementById('uploadBox').style.borderColor = '#4ade80';
            };
            reader.readAsDataURL(file);
        }

        async function uploadImageToSupabase(file) {
            if (!window.supabaseClient || !file) return null;
            const ext = file.name.split('.').pop();
            const fileName = 'product_' + Date.now() + '.' + ext;
            const { data: uploadData, error } = await window.supabaseClient
                .storage
                .from('product-images')
                .upload(fileName, file, { cacheControl: '3600', upsert: false });
            if (error) {
                console.error('Upload error:', error.message);
                return null;
            }
            const { data: urlData } = window.supabaseClient
                .storage
                .from('product-images')
                .getPublicUrl(fileName);
            return urlData.publicUrl || null;
        }

        async function handleAddProduct(e) {
            e.preventDefault();
            const btn = e.target.querySelector('.admin-submit-btn');
            const fileInput = document.getElementById('pImg');
            const file = fileInput.files[0];

            btn.textContent = '⏳ Uploading...';
            btn.disabled = true;
            document.getElementById('uploadStatus').textContent = file ? '⏳ Uploading photo...' : '';

            // Photo upload করো Supabase Storage তে
            let imageUrl = 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=600';
            if (file) {
                const uploaded = await uploadImageToSupabase(file);
                if (uploaded) {
                    imageUrl = uploaded;
                    document.getElementById('uploadStatus').textContent = '✅ Photo uploaded!';
                } else {
                    document.getElementById('uploadStatus').textContent = '⚠️ Upload failed, using default image.';
                }
            }

            const newProd = {
                id: Date.now(),
                name: document.getElementById('pName').value.trim(),
                price: parseFloat(document.getElementById('pPrice').value),
                category: document.getElementById('pCat').value,
                image: imageUrl,
                description: document.getElementById('pDesc').value.trim()
            };

            await dbAddProduct(newProd);
            data.products.unshift(newProd);
            saveAdminData('adminProducts', data.products);

            // Reset form
            e.target.reset();
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('uploadPrompt').style.display = 'block';
            document.getElementById('uploadBox').style.borderColor = '#fdb9c8';
            document.getElementById('uploadStatus').textContent = '';

            renderProducts();

            btn.textContent = '✅ Saved!';
            btn.style.background = '#4ade80';
            btn.style.color = 'white';
            btn.disabled = false;
            setTimeout(() => {
                btn.textContent = '💾 Save Product';
                btn.style.background = '';
                btn.style.color = '';
            }, 2500);
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            data.products = data.products.filter(p => p.id !== id);
            saveAdminData('adminProducts', data.products);

            // Sync to DB
            await dbDeleteProduct(id);

            const el = document.getElementById('prod-' + id);
            if (el) {
                el.style.opacity = '0';
                el.style.transform = 'translateX(20px)';
                el.style.transition = 'all 0.3s';
                setTimeout(() => renderProducts(), 300);
            }
        }
    </script>
</body>

</html>