-- ============================================================
-- FULL DATABASE SETUP ‚Äî Baking Corner (Final & Fixed)
-- ============================================================

-- ‡ßß. PRODUCTS TABLE
CREATE TABLE IF NOT EXISTS public.products (
    id              BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name            TEXT NOT NULL,
    price           NUMERIC(10,2) NOT NULL DEFAULT 0,
    category        TEXT DEFAULT 'cakes',
    status          TEXT DEFAULT 'in-stock', 
    image           TEXT,
    images          JSONB DEFAULT '[]'::jsonb,
    description     TEXT,
    pound_options   JSONB DEFAULT '[]'::jsonb,
    flavour_options JSONB DEFAULT '[]'::jsonb,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ß®. ORDERS TABLE (Main Shop)
CREATE TABLE IF NOT EXISTS public.orders (
    id               TEXT PRIMARY KEY,
    status           TEXT DEFAULT 'Pending',
    customer_name    TEXT,
    customer_phone   TEXT,
    customer_address TEXT,
    delivery_date    TEXT, 
    payment_method   TEXT,
    transaction_no   TEXT, 
    notes            TEXT,
    total            NUMERIC(10,2),
    items            JSONB,
    location_coords  TEXT,
    customer_battery INT DEFAULT 0,
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ß©. CATEGORIES TABLE
CREATE TABLE IF NOT EXISTS public.categories (
    id          BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name        TEXT NOT NULL,
    description TEXT DEFAULT '',
    icon        TEXT DEFAULT 'üè¨',
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ß™. POUND OPTIONS TABLE (Global)
CREATE TABLE IF NOT EXISTS public.pound_options (
    id          BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    value       NUMERIC NOT NULL,
    price       NUMERIC NOT NULL,
    label       TEXT,
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT pound_options_unique_val UNIQUE (value)
);

-- ‡ß´. FLAVOUR OPTIONS TABLE (Global)
CREATE TABLE IF NOT EXISTS public.flavour_options (
    id          BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name        TEXT NOT NULL UNIQUE,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ß¨. CUSTOM ORDERS TABLE (Design Upload)
CREATE TABLE IF NOT EXISTS public.custom_orders (
    id               BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    customer_name    TEXT NOT NULL,
    customer_phone   TEXT NOT NULL,
    delivery_address TEXT NOT NULL,
    delivery_date    TEXT,
    instructions     TEXT,
    pound_value      NUMERIC NOT NULL,
    flavour          TEXT,
    image_url        TEXT NOT NULL,
    payment_method   TEXT,          
    transaction_no   TEXT, 
    location_coords  TEXT,
    customer_battery INT DEFAULT 0,
    status           TEXT DEFAULT 'Pending',
    price            NUMERIC,
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ß≠. PAYMENT METHODS TABLE
CREATE TABLE IF NOT EXISTS public.payment_methods (
    id          BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name        TEXT NOT NULL,
    number      TEXT,
    instructions TEXT,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ßÆ. PRICE LIST TABLE
CREATE TABLE IF NOT EXISTS public.price_list (
    id          BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name        TEXT NOT NULL,
    weight      TEXT,
    price       TEXT NOT NULL,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

-- ‡ßØ. ADMIN SETTINGS TABLE (‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
CREATE TABLE IF NOT EXISTS public.admin_settings (
    id TEXT PRIMARY KEY,
    username TEXT DEFAULT 'admin',
    password TEXT DEFAULT 'admin',
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶á‡¶®‡¶∏‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
INSERT INTO public.admin_settings (id, username, password)
VALUES ('main_admin', 'admin', 'admin')
ON CONFLICT (id) DO NOTHING;

-- =======================================================
-- ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® (Patching Existing Tables)
-- =======================================================

-- Products Patches
ALTER TABLE public.products ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'in-stock';

-- Main Orders Table Patch
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS location_coords TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS customer_battery INT DEFAULT 0;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS transaction_no TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS payment_method TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS delivery_date TEXT;

-- Custom Orders Table Patch
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS location_coords TEXT;
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS customer_battery INT DEFAULT 0;
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS transaction_no TEXT;
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS payment_method TEXT;
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS flavour TEXT;
ALTER TABLE public.custom_orders ADD COLUMN IF NOT EXISTS delivery_date TEXT;

-- ============================================================
-- RLS POLICIES (‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ)
-- ============================================================

ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pound_options ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.flavour_options ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.custom_orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payment_methods ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.price_list ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_settings ENABLE ROW LEVEL SECURITY;

-- Policies for All Tables
DO $$
DECLARE
    t TEXT;
BEGIN
    FOR t IN SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' 
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS "Public Access" ON public.%I', t);
        EXECUTE format('CREATE POLICY "Public Access" ON public.%I FOR ALL USING (true)', t);
    END LOOP;
END $$;

-- STORAGE POLICIES (Bucket: product-images)
-- ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá‡¶® 'product-images' ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø PUBLIC bucket ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
DROP POLICY IF EXISTS "Public view images" ON storage.objects;
CREATE POLICY "Public view images" ON storage.objects FOR SELECT USING (bucket_id = 'product-images');

DROP POLICY IF EXISTS "Public upload images" ON storage.objects;
CREATE POLICY "Public upload images" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'product-images');
